name: Rust

on:
  push:
    branches:
      - main
      - new_variant
      - perplexity
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies for GTK4 and glib
      run: |
          sudo apt-get update
          sudo apt-get install -y \
            libdbus-1-dev \
            pkg-config \
            libgtk-4-dev \
            libadwaita-1-dev

    - name: Clean the project
      run: cargo clean 

    - name: Build the project (debug)
      run: cargo build --verbose

    - name: Run tests
      run: cargo test --verbose

    - name: Build release binaries
      run: cargo build --release --verbose

    - name: Create release tarball
      run: |
        mkdir -p release-package/bin
        cp target/release/tuxedo-daemon release-package/bin/
        cp target/release/tuxedo-control-center release-package/bin/
        
        # Copy systemd and dbus files
        mkdir -p release-package/systemd
        mkdir -p release-package/dbus
        cp debian/tuxedo-daemon.service release-package/systemd/ || true
        cp debian/com.tuxedo.Control.service release-package/dbus/ || true
        cp debian/com.tuxedo.Control.conf release-package/dbus/ || true
        
        # Copy documentation
        cp README.md LICENSE release-package/ 2>/dev/null || true
        
        # Create install script
        cat > release-package/install.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "Installing TUXEDO Control Center..."
        
        # Install binaries
        sudo install -D -m 755 bin/tuxedo-daemon /usr/local/bin/tuxedo-daemon
        sudo install -D -m 755 bin/tuxedo-control-center /usr/local/bin/tuxedo-control-center
        
        # Install systemd service
        if [ -f systemd/tuxedo-daemon.service ]; then
            sudo install -D -m 644 systemd/tuxedo-daemon.service /etc/systemd/system/tuxedo-daemon.service
        fi
        
        # Install dbus files
        if [ -f dbus/com.tuxedo.Control.service ]; then
            sudo install -D -m 644 dbus/com.tuxedo.Control.service /usr/share/dbus-1/system-services/com.tuxedo.Control.service
        fi
        
        if [ -f dbus/com.tuxedo.Control.conf ]; then
            sudo install -D -m 644 dbus/com.tuxedo.Control.conf /usr/share/dbus-1/system.d/com.tuxedo.Control.conf
        fi
        
        # Reload systemd and dbus
        sudo systemctl daemon-reload
        sudo systemctl restart dbus || true
        
        # Enable and start service
        sudo systemctl enable tuxedo-daemon.service
        sudo systemctl start tuxedo-daemon.service
        
        echo "âœ… Installation complete!"
        echo "Run 'tuxedo-control-center' to start the GUI"
        EOF
        
        chmod +x release-package/install.sh
        
        # Create the tarball
        tar -czf tuxedo-rs-ubuntu-24.04.tar.gz release-package/
        
        # Show contents and size
        echo "=== Tarball contents ==="
        tar -tzf tuxedo-rs-ubuntu-24.04.tar.gz
        echo ""
        echo "=== Tarball size ==="
        ls -lh tuxedo-rs-ubuntu-24.04.tar.gz

    - name: Upload release tarball
      uses: actions/upload-artifact@v4
      with:
        name: tuxedo-rs-ubuntu-24.04-tarball
        path: tuxedo-rs-ubuntu-24.04.tar.gz
        retention-days: 90

    - name: Upload individual binaries
      uses: actions/upload-artifact@v4
      with:
        name: tuxedo-rs-ubuntu-24.04-binaries
        path: |
          target/release/tuxedo-daemon
          target/release/tuxedo-control-center
        retention-days: 90
